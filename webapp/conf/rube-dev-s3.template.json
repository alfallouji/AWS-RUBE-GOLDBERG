{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"Create bucket and setup replication",
    "Parameters":{
        "sourceBucketName":{
            "Description":"Name for the source bucket",
            "Type":"String"
        },
        "destinationBucketName":{
            "Description":"Name for the destination bucket",
            "Type":"String"
        }
    },
    "Resources":{
        "rubegoldoutput":{
            "Type":"AWS::S3::Bucket",
            "Properties":{
                "BucketName":{
                    "Ref":"destinationBucketName"
                },
                "PublicAccessBlockConfiguration":{
                    "BlockPublicAcls":true,
                    "BlockPublicPolicy":true,
                    "IgnorePublicAcls":true,
                    "RestrictPublicBuckets":true
                },
                "VersioningConfiguration":{
                    "Status":"Enabled"
                }
            },
            "UpdateReplacePolicy":"Delete",
            "DeletionPolicy":"Delete",
            "Metadata":{
                "aws:cdk:path":"rube-dev-s3/rube-gold-output/Resource"
            }
        },
        "rubegoldinput":{
            "Type":"AWS::S3::Bucket",
            "DependsOn":[
                "rubegoldoutput"
            ],
            "Properties":{
                "BucketName":{
                    "Ref":"sourceBucketName"
                },
                "PublicAccessBlockConfiguration":{
                    "BlockPublicAcls":true,
                    "BlockPublicPolicy":true,
                    "IgnorePublicAcls":true,
                    "RestrictPublicBuckets":true
                },
                "VersioningConfiguration":{
                    "Status":"Enabled"
                },
                "ReplicationConfiguration":{
                    "Role":{
                        "Fn::GetAtt":[
                            "BucketRole",
                            "Arn"
                        ]
                    },
                    "Rules":[
                        {
                            "Destination":{
                                "Bucket":{
                                    "Fn::Sub":"arn:aws:s3:::${destinationBucketName}"
                                }
                            },
                            "Prefix":"",
                            "Status":"Enabled"
                        }
                    ]
                }
            },
            "UpdateReplacePolicy":"Delete",
            "DeletionPolicy":"Delete",
            "Metadata":{
                "aws:cdk:path":"rube-dev-s3/rube-gold-output/Resource"
            }
        },
        "BucketRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "Path":"/",
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Principal":{
                                "Service":[
                                    "s3.amazonaws.com"
                                ]
                            },
                            "Action":[
                                "sts:AssumeRole"
                            ],
                            "Effect":"Allow"
                        }
                    ]
                },
                "Policies":[
                    {
                        "PolicyName":"bucket-replication-permissions",
                        "PolicyDocument":{
                            "Version":"2012-10-17",
                            "Statement":[
                                {
                                    "Effect":"Allow",
                                    "Action":[
                                        "s3:GetObjectVersionForReplication",
                                        "s3:GetObjectVersionAcl"
                                    ],
                                    "Resource":[
                                        {
                                            "Fn::Sub":"arn:aws:s3:::${sourceBucketName}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect":"Allow",
                                    "Action":[
                                        "s3:ListBucket",
                                        "s3:GetReplicationConfiguration"
                                    ],
                                    "Resource":[
                                        {
                                            "Fn::Sub":"arn:aws:s3:::${sourceBucketName}"
                                        }
                                    ]
                                },
                                {
                                    "Effect":"Allow",
                                    "Action":[
                                        "s3:ReplicateObject",
                                        "s3:ReplicateDelete",
                                        "s3:ReplicateTags",
                                        "s3:GetObjectVersionTagging"
                                    ],
                                    "Resource":{
                                        "Fn::Sub":"arn:aws:s3:::${destinationBucketName}/*"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        }
    },
    "Outputs":{
        
    }
}